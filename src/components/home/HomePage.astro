---
import SocialList from "@/components/SocialList.astro";
import PostPreview from "@/components/blog/PostPreview.astro";
import Note from "@/components/note/Note.astro";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";
import { getAllPosts } from "@/data/post";
import { filterNotesByLang, getAllNotes } from "@/data/note";
import {
  getLangFromUrl,
  useTranslatedPath,
  useTranslations,
} from "@/i18n/utils";
import { defaultLang } from "@/i18n/ui";

const pageLang = getLangFromUrl(Astro.url) ?? defaultLang;
const translatePath = useTranslatedPath(pageLang);
const t = useTranslations(pageLang);

const MAX_POSTS = 10;
const MAX_PINNED_POSTS = 3;
const MAX_NOTES = 5;

const localizedPosts = (await getAllPosts(pageLang)).sort(collectionDateSort);
const postsForList = localizedPosts.slice(0, MAX_POSTS);
const pinnedPosts = postsForList
  .filter((p) => p.data.pinned)
  .slice(0, MAX_PINNED_POSTS);

const allNotes = await getAllNotes();
const localizedNotes = filterNotesByLang(allNotes, pageLang)
  .sort(collectionDateSort)
  .slice(0, MAX_NOTES);

const hasPinnedPosts = pinnedPosts.length > 0;
const hasPosts = postsForList.length > 0;
const hasNotes = localizedNotes.length > 0;

const postsLink = translatePath("/posts/");
const notesLink = translatePath("/notes/");

const metaTitle = t("home.metaTitle");
const heroHeading = t("home.heading");
const introParagraphs = [
  t("home.intro.p1"),
  t("home.intro.p2"),
  t("home.intro.p3"),
];
const pinnedLabel = t("home.sections.pinned");
const postsLabel = t("home.sections.posts");
const notesLabel = t("home.sections.notes");
---

<PageLayout meta={{ title: metaTitle }}>
  <section>
    <h1 class="title mb-8">{heroHeading}</h1>

    <div class="max-w-2xl">
      {
        introParagraphs.map((paragraph, index) => (
          <p
            class:list={{
              // spacing
              "mb-3": index < introParagraphs.length - 1,
              "mb-6": index === introParagraphs.length - 1,

              // hierarchy
              "text-base font-medium text-neutral-900 dark:text-white leading-relaxed":
                index === 0,

              "text-sm text-neutral-700 dark:text-neutral-300 leading-relaxed":
                index > 0 && index < introParagraphs.length - 1,

              "text-sm text-neutral-600 dark:text-neutral-400 leading-relaxed":
                index === introParagraphs.length - 1,
            }}
          >
            {paragraph}
          </p>
        ))
      }
    </div>

    <div class="mt-2">
      <SocialList />
    </div>
  </section>
  {
    hasPinnedPosts && (
      <section class="mt-16">
        <h2 class="title mb-6 text-xl">{pinnedLabel}</h2>
        <ul class="space-y-4" role="list">
          {pinnedPosts.map((p) => (
            <li class="grid gap-1 sm:grid-cols-[auto_1fr]">
              <PostPreview lang={pageLang} post={p} />
            </li>
          ))}
        </ul>
      </section>
    )
  }
  {
    hasPosts && (
      <section class="mt-16">
        <h2 class="title text-accent mb-6 text-xl">
          <a href={postsLink}>{postsLabel}</a>
        </h2>
        <ul class="space-y-4" role="list">
          {postsForList.map((p) => (
            <li class="grid gap-1 sm:grid-cols-[auto_1fr]">
              <PostPreview lang={pageLang} post={p} />
            </li>
          ))}
        </ul>
      </section>
    )
  }
  {
    hasNotes && (
      <section class="mt-16">
        <h2 class="title text-accent mb-6 text-xl">
          <a href={notesLink}>{notesLabel}</a>
        </h2>
        <ul class="space-y-6" role="list">
          {localizedNotes.map((note) => (
            <li>
              <Note note={note} as="h3" isPreview />
            </li>
          ))}
        </ul>
      </section>
    )
  }
</PageLayout>
